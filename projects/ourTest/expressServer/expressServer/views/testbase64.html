<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<input type="file" accept='image/*' id="file"><br>
<div id='test'>
</div>
<!--图片: <img src="" id="img1" class='file-preview-image' width="100px" height="100">-->
<div id="content" style="height: 100%; width: 100%"></div>
<button onclick="submit()">submit</button>
</body>
</html>
<script src="/javascripts/ajax.js"></script>
<script>
    // var ajax = require( "ajax" );
    document.querySelector("#file").addEventListener("change", function () {
        var file = document.querySelector("#file").files[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = res => {
            var img = new Image();
            img.src = res.target.result;
            //document.getElementById('test').innerHTML = `<img src=${img.src}` id="img1" class='file-preview-image' width="100px" height="100">`;
            //document.getElementById('img1').setAttribute("src", `${img.src}`);
           /* document.getElementById('content').style.background = `url( ${img.src})`;
            ajax({
                url: "http://127.0.0.1:30001/users/uploadFile",
                type: 'post',
                data: {
                    url: img.src
                },
                dataType: 'json',
                timeout: 10000,
                contentType: "application/json",
                success: function (data) {
                    //服务器返回响应，根据响应结果，分析是否登录成功
                },
                //异常处理
                error: function (e) {
                    console.log(e);
                }
            })*/
          /* const url =  getBase64Image(img);
           console.log(url)
           document.getElementById('content').style.background = `url( ${url})`*/
            img.onload = function(){
                console.log("宽度为：",this.width,"高度为：",this.height);
                // 缩放图片需要的canvas
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                var originWidth = this.width;
                var originHeight = this.height;
                // 最大尺寸限制
                var maxWidth = 400, maxHeight = 400;
                // 目标尺寸
                var targetWidth = originWidth, targetHeight = originHeight;
                // 图片尺寸超过400x400的限制
                if (originWidth > maxWidth || originHeight > maxHeight) {
                    if (originWidth / originHeight > maxWidth / maxHeight) {
                        // 更宽，按照宽度限定尺寸
                        targetWidth = maxWidth;
                        targetHeight = Math.round(maxWidth * (originHeight / originWidth));
                    } else {
                        targetHeight = maxHeight;
                        targetWidth = Math.round(maxHeight * (originWidth / originHeight));
                    }
                }
                // canvas对图片进行缩放
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                // 清除画布
                context.clearRect(0, 0, targetWidth, targetHeight);
                // 图片压缩
                context.drawImage(img, 0, 0, targetWidth, targetHeight);
                // 压缩之后上传blob文件到后端
                canvas.toBlob(function (blob) {
                    // 分片
                    uploadFile('/upload', file, function (err, res) {
                        if (err) { return console.log(err); }
                        console.log('upload successfully!');
                    });
                }, file.type || 'image/png');

            }
            // getBase64Image(img)
        };


    });
    function uploadFile (url, blob, callback) {
        var perFileSize = 2097152; // 2 * 1024 * 1024
        var blobParts = Math.ceil(blob.size / perFileSize);

        for (var i = 0; i < blobParts; i++) {
            (function (i) {
                var fd = new FormData();
                var _blob = blob.slice(i * perFileSize, (i + 1) * perFileSize);

                fd.append('_blob', _blob);
                fd.append('filename', blob.name);
                fd.append('index', i + 1);
                fd.append('total', blobParts);
                ajax(
                    {
                        url: "http://127.0.0.1:30001/users/uploadFile",
                        type: 'post',
                        data: fd,
                        processData: false,
                        contentType: false,
                        timeout: 10000,
                        success: function (data) {
                            //服务器返回响应，根据响应结果，分析是否登录成功
                        },
                        //异常处理
                        error: function (e) {
                            console.log(e);
                        }
                    }
                )
            })(i)
        }
    }

    function submit() {
        ajax(
            {
                url: "http://127.0.0.1:30001/users/",
                type: 'get',
                data: {
                    username: 'username',
                    password: 'password'
                },
                dataType: 'json',
                timeout: 10000,
                contentType: "application/json",
                success: function (data) {
                    //服务器返回响应，根据响应结果，分析是否登录成功
                },
                //异常处理
                error: function (e) {
                    console.log(e);
                }
            }
        )
    }

    function getBase64Image(img) {
        var canvas = document.createElement('canvas');
        canvas.height = 400; //img.height;
        canvas.width = 300; //img.width;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, 300, 400);
        document.getElementById('test').appendChild(canvas);
        var ext = img.src.substring(img.src.lastIndexOf('.') + 1).toLowerCase();
        var dataURL = canvas.toDataURL('image/' + ext);
        return dataURL
    }
</script>